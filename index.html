<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CR Coach (MVP)</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; max-width: 820px; margin: 24px auto; padding: 0 16px; }
    input, button { font-size: 16px; padding: 8px 12px; }
    .row { display: flex; gap: 8px; margin-bottom: 16px; }
    pre { background:#f6f6f6; padding:12px; overflow:auto; }
    .card { border:1px solid #ddd; border-radius:10px; padding:12px; margin:10px 0; }
  </style>
</head>
<body>
  <h1>CR Coach (MVP grátis)</h1>
  <p>Cole sua <b>TAG</b> (ex.: <code>#ABCD123</code>). Dica: a TAG usa só <code>0289CGJLPQRUVY</code> — troque <code>O→0</code> e deixe em maiúsculas.</p>

  <div class="row">
    <input id="tag" placeholder="#ABCD123" style="flex:1" />
    <button id="go">Ver perfil</button>
  </div>

  <div id="out"></div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const out = $("#out");
    $("#go").onclick = async () => {
      out.innerHTML = "Carregando...";
      let tag = $("#tag").value.trim().toUpperCase().replace(/O/g,"0");
      if (!tag.startsWith("#")) tag = "#" + tag;

      try {
        const [playerRes, logRes] = await Promise.all([
          fetch(`/api/player?tag=${encodeURIComponent(tag)}`),
          fetch(`/api/battlelog?tag=${encodeURIComponent(tag)}`),
        ]);

        if (!playerRes.ok) throw new Error("Erro ao carregar perfil");
        if (!logRes.ok) throw new Error("Erro ao carregar histórico");

        const player = await playerRes.json();
        const log = await logRes.json();

        const winLoss = (log || []).reduce((acc, b) => {
          const teamCrowns = (b.team?.[0]?.crowns ?? 0);
          const oppCrowns  = (b.opponent?.[0]?.crowns ?? 0);
          if (teamCrowns > oppCrowns) acc.wins++;
          else if (teamCrowns < oppCrowns) acc.losses++;
          else acc.draws++;
          return acc;
        }, { wins:0, losses:0, draws:0 });

        const total = winLoss.wins + winLoss.losses + winLoss.draws || 1;
        const winrate = ((winLoss.wins / total) * 100).toFixed(1);

        out.innerHTML = `
          <div class="card">
            <h2>${player.name} <small>(${player.tag})</small></h2>
            <p><b>Arena:</b> ${player.arena?.name || "?"} — <b>Troféus:</b> ${player.trophies ?? "?"}</p>
            <p><b>Clã:</b> ${player.clan?.name || "—"}</p>
          </div>

          <div class="card">
            <h3>Últimas partidas</h3>
            <p><b>Winrate:</b> ${winrate}% · (W:${winLoss.wins} / L:${winLoss.losses} / D:${winLoss.draws})</p>
            <details><summary>Ver JSON bruto (debug)</summary><pre>${escapeHtml(JSON.stringify(log, null, 2))}</pre></details>
          </div>
        `;
      } catch (e) {
        out.innerHTML = `<div class="card"><b>Erro:</b> ${e.message}</div>`;
      }
    };

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
    }
  </script>
</body>
</html>
